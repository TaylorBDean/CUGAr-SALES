name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  schedule:
    # Run weekly to catch secrets in history
    - cron: '0 0 * * 0'

env:
  SECRET_SCANNER: on

jobs:
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan
      
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          # Scan git history, not just current commit
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          # Fail on verified secrets only (reduce false positives)
          extra_args: --only-verified --fail

  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: for enhanced features

  env-parity-check:
    name: Validate .env.example Parity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install python-dotenv loguru
      
      - name: Run .env.example parity check
        run: |
          python - <<'EOF'
          import sys
          from pathlib import Path
          sys.path.insert(0, 'src')
          
          from cuga.security.secrets import validate_env_parity
          
          # Check root .env.example
          is_valid, missing = validate_env_parity(Path('.env.example'))
          
          if not is_valid:
              print(f"❌ .env.example parity check failed!")
              print(f"Missing keys: {', '.join(missing)}")
              print("\nPlease ensure all keys in .env.example are documented.")
              sys.exit(1)
          else:
              print("✅ .env.example parity check passed")
          EOF

  hardcoded-secrets-check:
    name: Detect Hardcoded Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Scan Python files for hardcoded secrets
        run: |
          python - <<'EOF'
          import sys
          from pathlib import Path
          sys.path.insert(0, 'src')
          
          from cuga.security.secrets import detect_hardcoded_secrets
          
          findings = []
          for py_file in Path('src').rglob('*.py'):
              if '.venv' in str(py_file) or 'node_modules' in str(py_file):
                  continue
              
              code = py_file.read_text()
              file_findings = detect_hardcoded_secrets(code)
              
              if file_findings:
                  findings.append((py_file, file_findings))
          
          if findings:
              print("❌ Potential hardcoded secrets detected:")
              for file_path, file_findings in findings:
                  print(f"\n{file_path}:")
                  for finding in file_findings:
                      print(f"  Line {finding['line']}: {finding['description']}")
                      print(f"    {finding['snippet']}")
              
              print("\n⚠️  Use environment variables instead of hardcoded secrets!")
              print("See docs/configuration/ENVIRONMENT_MODES.md")
              sys.exit(1)
          else:
              print("✅ No hardcoded secrets detected")
          EOF

  secrets-summary:
    name: Secret Scan Summary
    runs-on: ubuntu-latest
    needs: [trufflehog, gitleaks, env-parity-check, hardcoded-secrets-check]
    if: always()
    steps:
      - name: Check all secret scans passed
        run: |
          if [[ "${{ needs.trufflehog.result }}" == "failure" ]] || \
             [[ "${{ needs.gitleaks.result }}" == "failure" ]] || \
             [[ "${{ needs.env-parity-check.result }}" == "failure" ]] || \
             [[ "${{ needs.hardcoded-secrets-check.result }}" == "failure" ]]; then
            echo "❌ Secret scanning failed. Review findings above."
            exit 1
          else
            echo "✅ All secret scans passed successfully!"
          fi
